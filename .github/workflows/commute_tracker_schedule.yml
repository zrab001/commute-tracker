name: scheduled-run-commute-tracker

# ============================================================
# Commute Tracker – Scheduled + Manual Execution
#
# Business timezone: America/New_York (EST / EDT)
#
# GitHub Actions cron runs in UTC ONLY.
#
# SCHEDULE LOGIC (DST-SAFE, WIDE WINDOW):
# ------------------------------------------------------------
# Morning Window (EST/EDT enforced in R):
#   05:00 – 11:00 local
#
# Evening Window (EST/EDT enforced in R):
#   17:00 – 18:00 local   (TEMPORARY, SAFE)
#
# Scheduler fires every 10 minutes during:
#   10:00–15:59 UTC
#   22:00–22:59 UTC
#
# IMPORTANT:
# - R script exits cleanly if outside business windows
# - Scheduler may fire, but NO DATA is written unless valid
#
# CONCURRENCY BEHAVIOR:
# ------------------------------------------------------------
# ✔ NEW run cancels OLD run immediately
# ✖ Old run never blocks a newer run
# ============================================================

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled execution (UTC)
  schedule:
    - cron: '*/10 10-15,22 * * *'

# ------------------------------------------------------------
# Concurrency: NEW RUN WINS
# ------------------------------------------------------------
concurrency:
  # All runs of this workflow share the same lock
  group: commute-tracker-main
  cancel-in-progress: true

jobs:
  run-commute-tracker:
    runs-on: ubuntu-latest

    env:
      BUSINESS_TZ: America/New_York
      R_LIBS_USER: ${{ github.workspace }}/R/library

    steps:
      # --------------------------------------------------------
      # Checkout repository
      # --------------------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Set up R
      # --------------------------------------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          r-lib-path: ${{ env.R_LIBS_USER }}

      # --------------------------------------------------------
      # Restore R package cache
      # --------------------------------------------------------
      - name: Restore R package cache
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: r-${{ runner.os }}-${{ hashFiles('config/commute_config.yml', 'scripts/**/*.R', 'R/**/*.R') }}
          restore-keys: |
            r-${{ runner.os }}-

      # --------------------------------------------------------
      # Install Linux system dependencies
      # --------------------------------------------------------
      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      # --------------------------------------------------------
      # Install R dependencies (minimal, cached)
      # --------------------------------------------------------
      - name: Install R dependencies
        run: |
          Rscript -e '
            dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)
            .libPaths(Sys.getenv("R_LIBS_USER"))

            options(repos = c(CRAN = "https://cloud.r-project.org"))

            pkgs <- c(
              "googlesheets4",
              "httr",
              "jsonlite",
              "lubridate",
              "dplyr",
              "purrr",
              "magrittr",
              "yaml",
              "tibble"
            )

            missing <- pkgs[!pkgs %in% installed.packages()[, "Package"]]

            if (length(missing)) {
              install.packages(missing, lib = Sys.getenv("R_LIBS_USER"))
            }

            cat("Installed packages:\\n")
            print(installed.packages(lib.loc = Sys.getenv("R_LIBS_USER"))[pkgs, "Package"])
          '

      # --------------------------------------------------------
      # Write Google service account key
      # --------------------------------------------------------
      - name: Write Google service account key
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > sa-key.json

      # --------------------------------------------------------
      # Run commute tracker
      # --------------------------------------------------------
      - name: Run commute tracker
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa-key.json
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          Rscript scripts/hello_commute_tracker.R

      # --------------------------------------------------------
      # Log concurrency cancellation (if THIS run was canceled)
      # --------------------------------------------------------
      - name: Log concurrency cancellation
        if: ${{ cancelled() }}
        run: |
          echo "$(date -u '+%Y-%m-%d %H:%M:%S'),${{ github.run_id }},${{ github.run_number }},${{ github.workflow }},cancelled_by_newer_run" \
            >> logs/concurrency_cancellation_log.csv

      # --------------------------------------------------------
      # Commit log files (ALWAYS)
      # --------------------------------------------------------
      - name: Commit logs
        if: always()
        run: |
          git config user.name "commute-tracker-bot"
          git config user.email "commute-tracker-bot@users.noreply.github.com"

          git add logs/route_fallback_log.csv logs/concurrency_cancellation_log.csv || true

          if git diff --cached --quiet; then
            echo "No log changes to commit"
          else
            git commit -m "Log runtime events [skip ci]"
            git push
          fi
