name: scheduled-run-commute-tracker

# ============================================================
# Commute Tracker – Scheduled + Manual Execution
#
# Business timezone: America/New_York (EST / EDT)
#
# GitHub Actions cron runs in UTC ONLY.
#
# STRATEGY:
# ------------------------------------------------------------
# - Cron fires broadly (DST-safe)
# - R script enforces strict commute windows
# - Scheduler heartbeat proves when cron actually fires
#
# SCHEDULE WINDOWS (UTC, wide on purpose):
# ------------------------------------------------------------
# Morning: 10:00–15:59 UTC  (covers 05:00–11:59 EST/EDT)
# Evening: 19:00–23:59 UTC  (covers 14:00–19:59 EST/EDT)
#
# Frequency: Every 10 minutes
#
# CONCURRENCY:
# - If a new run starts while one is active,
#   the OLD run is cancelled immediately.
# ============================================================

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:

  # Scheduled trigger (UTC)
  schedule:
    - cron: '*/10 10-15,19-23 * * *'

# ------------------------------------------------------------
# Concurrency: "New run wins"
# ------------------------------------------------------------
#concurrency:
#  group: commute-tracker-${{ github.ref }}
#  cancel-in-progress: true

jobs:
  run-commute-tracker:
    runs-on: ubuntu-latest

    env:
      # Used by R for logging and business logic
      BUSINESS_TZ: America/New_York

      # Explicit R library path (for cache stability)
      R_LIBS_USER: ${{ github.workspace }}/R/library

    steps:
      # --------------------------------------------------------
      # Checkout repository
      # --------------------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Scheduler heartbeat (CRITICAL DEBUG STEP)
      # --------------------------------------------------------
      - name: Scheduler heartbeat
        run: |
          echo "======================================"
          echo "SCHEDULER HEARTBEAT"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Run ID:   $GITHUB_RUN_ID"
          echo "Event:    $GITHUB_EVENT_NAME"
          echo "UTC time: $(date -u)"
          echo "NY time:  $(TZ=America/New_York date)"
          echo "======================================"

      # --------------------------------------------------------
      # Set up R
      # --------------------------------------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          r-lib-path: ${{ env.R_LIBS_USER }}

      # --------------------------------------------------------
      # Restore R package cache
      # --------------------------------------------------------
      - name: Restore R package cache
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: r-${{ runner.os }}-${{ hashFiles('config/commute_config.yml', 'scripts/**/*.R', 'R/**/*.R') }}
          restore-keys: |
            r-${{ runner.os }}-

      # --------------------------------------------------------
      # Install Linux system dependencies (REQUIRED)
      # --------------------------------------------------------
      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      # --------------------------------------------------------
      # Install R dependencies (cached, minimal)
      # --------------------------------------------------------
      - name: Install R dependencies
        run: |
          Rscript -e '
            dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)
            .libPaths(Sys.getenv("R_LIBS_USER"))

            options(repos = c(CRAN = "https://cloud.r-project.org"))

            pkgs <- c(
              "googlesheets4",
              "httr",
              "jsonlite",
              "lubridate",
              "dplyr",
              "purrr",
              "magrittr",
              "yaml",
              "tibble"
            )

            installed <- rownames(installed.packages())
            missing <- setdiff(pkgs, installed)

            if (length(missing)) {
              install.packages(missing, lib = Sys.getenv("R_LIBS_USER"))
            }

            cat("R packages ready:\n")
            print(pkgs)
          '

      # --------------------------------------------------------
      # Write Google service account key
      # --------------------------------------------------------
      - name: Write Google service account key
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > sa-key.json

      # --------------------------------------------------------
      # Run commute tracker (R script enforces time windows)
      # --------------------------------------------------------
      - name: Run commute tracker
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa-key.json
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          Rscript scripts/hello_commute_tracker.R

      # --------------------------------------------------------
      # Commit route fallback logs (best-effort)
      # --------------------------------------------------------
      - name: Commit route fallback logs
        if: always()
        run: |
          git config user.name "commute-tracker-bot"
          git config user.email "commute-tracker-bot@users.noreply.github.com"

          git status
          git add logs/route_fallback_log.csv || true

          if git diff --cached --quiet; then
            echo "No log changes to commit"
          else
            git commit -m "Log route fallback event [skip ci]"
            git push || echo "Log commit skipped (no permissions)"
          fi
