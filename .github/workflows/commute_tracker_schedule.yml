name: run-commute-tracker

# ============================================================
# Commute Tracker – Scheduled + Manual Execution
#
# Business timezone: America/New_York (EST / EDT)
#
# GitHub Actions cron runs in UTC ONLY.
#
# SCHEDULE LOGIC (Combined EST + EDT):
# ------------------------------------------------------------
# Morning Window: 05:00 – 11:00 EST (10:00 – 16:00 UTC)
# Evening Window: 14:00 – 19:00 EST (19:00 – 00:00 UTC)
# Frequency: Every 10 minutes
#
# CONCURRENCY:
# If a job is still running when the next 10m triggers, 
# the old job is CANCELLED immediately.
# ============================================================

on:
  # Allow manual execution from GitHub UI
  workflow_dispatch:

  # Scheduled execution (UTC)
  schedule:
    # -----------------------------
    # Combined Morning & Evening Windows (DST Safe)
    # -----------------------------
    # 10-15: Runs 10:00 UTC (5am EST) through 15:50 UTC (10:50am EST)
    # 19-23: Runs 19:00 UTC (2pm EST) through 23:50 UTC (6:50pm EST)
    - cron: '*/10 10-15,19-23 * * *'

# ------------------------------------------------------------
# Concurrency Strategy: "Ruthless Cancel"
# ------------------------------------------------------------
concurrency:
  group: commute-tracker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-commute-tracker:
    runs-on: ubuntu-latest

    env:
      # Used by R for logging only
      BUSINESS_TZ: America/New_York
      # Explicitly set R_LIBS_USER for caching consistency
      R_LIBS_USER: ${{ github.workspace }}/R/library

    steps:
      # --------------------------------------------------------
      # Checkout repository
      # --------------------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Set up R
      # --------------------------------------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          # Tell setup-r to use our custom lib path
          r-lib-path: ${{ env.R_LIBS_USER }}

      # --------------------------------------------------------
      # Restore R package cache (shared across workflows)
      # --------------------------------------------------------
      - name: Restore R package cache
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          # Hash config/scripts so we invalidate cache if dependencies change
          key: r-${{ runner.os }}-${{ hashFiles('config/commute_config.yml', 'scripts/**/*.R', 'R/**/*.R') }}
          restore-keys: |
            r-${{ runner.os }}-

      # --------------------------------------------------------
      # NEW: Install Linux system dependencies
      # Required for curl, httr, and openssl to compile
      # --------------------------------------------------------
      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      # --------------------------------------------------------
      # Install R dependencies (cached)
      # --------------------------------------------------------
      - name: Install R dependencies
        run: |
          Rscript -e '
            # Create library directory if it does not exist
            dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)
            .libPaths(Sys.getenv("R_LIBS_USER"))
            
            options(repos = c(CRAN = "https://cloud.r-project.org"))
      
            pkgs <- c(
              "googlesheets4",
              "httr",
              "jsonlite",
              "lubridate",
              "dplyr",
              "purrr",
              "magrittr",
              "yaml",
              "tibble"
            )
      
            # Only install what is missing
            missing <- pkgs[!pkgs %in% installed.packages()[, "Package"]]
            
            if (length(missing)) {
              # FIXED: Removed "dependencies = TRUE" to avoid installing heavy "Suggests" packages (sf, jpeg)
              install.packages(missing, lib = Sys.getenv("R_LIBS_USER"))
            }
      
            cat("Installed packages:\n")
            print(installed.packages(lib.loc = Sys.getenv("R_LIBS_USER"))[pkgs, "Package"])
          '

      # --------------------------------------------------------
      # Write Google service account key
      # --------------------------------------------------------
      - name: Write Google service account key
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > sa-key.json

      # --------------------------------------------------------
      # Run commute tracker
      # --------------------------------------------------------
      - name: Run commute tracker
        env:
          # This variable tells R where the key is automatically
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa-key.json
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          Rscript scripts/hello_commute_tracker.R

      # --------------------------------------------------------
      # Commit route fallback logs (ALWAYS)
      # --------------------------------------------------------
      - name: Commit route fallback logs
        if: always()
        run: |
          git config user.name "commute-tracker-bot"
          git config user.email "commute-tracker-bot@users.noreply.github.com"

          git status
          git add logs/route_fallback_log.csv || true

          if git diff --cached --quiet; then
            echo "No log changes to commit"
          else
            git commit -m "Log route fallback event [skip ci]"
            git push
          fi
